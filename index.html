<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Resistor Simulator Stage 1.3</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
    }
    canvas {
      border: 1px solid #000;
      margin: 10px 0;
      max-width: 100%;
      height: auto;
    }
    #controls {
      margin: 15px 0;
    }
    button {
      margin: 5px;
      padding: 8px 14px;
      font-size: 16px;
    }
    #answer {
      margin-top: 15px;
      font-weight: bold;
      color: darkblue;
    }
  </style>
</head>
<body>
  <h2>電阻器色碼與數字碼教育模擬器</h2>

  <div id="controls">
    <label for="mode">選擇模式：</label>
    <select id="mode">
      <option value="E24-4band">E24 四環色碼</option>
      <option value="E48-5band">E48 五環色碼</option>
      <option value="E96-5band">E96 五環色碼</option>
      <option value="E24-3digit">E24 三位數字碼</option>
      <option value="E48-4digit">E48 四位數字碼</option>
      <option value="E96-4digit">E96 四位數字碼</option>
    </select>
    <button onclick="newQuestion()">下一題</button>
    <button onclick="showAnswer()">顯示答案</button>
  </div>

  <canvas id="resistorCanvas" width="500" height="200"></canvas>

  <div id="answer"></div>

  <script>
    // 基本色碼表
    const colorTable = ["black","brown","red","orange","yellow","green","blue","violet","gray","white"];
    const multiplierColors = {
      "-2":"silver","-1":"gold","0":"black","1":"brown","2":"red","3":"orange",
      "4":"yellow","5":"green","6":"blue","7":"violet","8":"gray","9":"white"
    };

    // E 系列數值
    const E24 = [10,11,12,13,15,16,18,20,22,24,27,30,33,36,39,43,47,51,56,62,68,75,82,91];
    const E48 = [100,105,110,115,121,127,133,140,147,154,162,169,178,187,196,205,
                 215,226,237,249,261,274,287,301,316,332,348,365,383,402,422,442,464,487,
                 511,536,562,590,619,649,681,715,750,787,825,866,909,953];
    const E96 = [100,102,105,107,110,113,115,118,121,124,127,130,133,137,140,143,
                 147,150,154,158,162,165,169,174,178,182,187,191,196,200,205,210,215,221,226,
                 232,237,243,249,255,261,267,274,280,287,294,301,309,316,324,332,340,348,357,
                 365,374,383,392,402,412,422,432,442,453,464,475,487,499,511,523,536,549,562,
                 576,590,604,619,634,649,665,681,698,715,732,750,768,787,806,825,845,866,887,
                 909,931,953,976];

    let currentAnswer = "";

    function randomFrom(array) {
      return array[Math.floor(Math.random()*array.length)];
    }

    function generateResistorValue(mode) {
      let base, series;
      if(mode.startsWith("E24")) series = E24;
      if(mode.startsWith("E48")) series = E48;
      if(mode.startsWith("E96")) series = E96;

      base = randomFrom(series);

      let multiplier = Math.floor(Math.random()*7)-2; // 10^-2 ~ 10^4
      let value = base * Math.pow(10, multiplier);

      return {value:value, base:base, multiplier:multiplier};
    }

    function formatValue(val) {
      if(val >= 1e6) return (val/1e6).toFixed(2).replace(/\.?0+$/,"")+" MΩ";
      if(val >= 1e3) return (val/1e3).toFixed(2).replace(/\.?0+$/,"")+" kΩ";
      if(val >= 1) return val.toFixed(2).replace(/\.?0+$/,"")+" Ω";
      return (val*1000).toFixed(2).replace(/\.?0+$/,"")+" mΩ";
    }

    function drawResistor(base, multiplier, bands) {
      let canvas = document.getElementById("resistorCanvas");
      let ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // 主體
      ctx.fillStyle = "#d2b48c";
      ctx.fillRect(100,80,300,40);

      // 腳
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 5;
      ctx.beginPath();
      ctx.moveTo(0,100);
      ctx.lineTo(100,100);
      ctx.moveTo(400,100);
      ctx.lineTo(500,100);
      ctx.stroke();

      // 色環
      let digits = String(base);
      let bandX = 120;
      for(let i=0;i<bands-2;i++){
        let digit = parseInt(digits[i]);
        ctx.fillStyle = colorTable[digit];
        ctx.fillRect(bandX,80,10,40);
        bandX+=20;
      }
      // 倍率環
      ctx.fillStyle = multiplierColors[multiplier.toString()]||"black";
      ctx.fillRect(bandX,80,10,40);

      // 容差環
      bandX+=20;
      ctx.fillStyle = "gold";
      ctx.fillRect(bandX,80,10,40);
    }

    function drawSMD(value, digits) {
      let canvas = document.getElementById("resistorCanvas");
      let ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,canvas.width,canvas.height);

      ctx.fillStyle = "lightgray";
      ctx.fillRect(150,60,200,80);

      ctx.fillStyle = "black";
      ctx.fillRect(150,60,20,80);
      ctx.fillRect(330,60,20,80);

      ctx.fillStyle = "white";
      ctx.font = "30px Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(value,250,100);
    }

    function newQuestion() {
      let mode = document.getElementById("mode").value;
      let obj = generateResistorValue(mode);

      if(mode.includes("band")) {
        let bands = mode.includes("4band")?4:5;
        drawResistor(obj.base,obj.multiplier,bands);
        currentAnswer = formatValue(obj.value)+" 容差 ±"+(mode.includes("E24")?"5%":mode.includes("E48")?"2%":"1%");
      }
      else {
        // SMD 數字碼
        let code="";
        let val = obj.value;

        if(mode.includes("3digit")) {
          let exponent = Math.floor(Math.log10(val));
          let mantissa = val/Math.pow(10,exponent);
          mantissa = Math.round(mantissa*10)/10; 
          let baseDigits = Math.round(mantissa*10);
          code = String(baseDigits).padEnd(3,"0");
        }
        if(mode.includes("4digit")) {
          let exponent = Math.floor(Math.log10(val))-2;
          let mantissa = val/Math.pow(10,exponent);
          code = String(Math.round(mantissa)).padEnd(4,"0");
        }

        drawSMD(code,mode.includes("3digit")?3:4);
        currentAnswer = formatValue(obj.value)+" 容差 ±"+(mode.includes("E24")?"5%":mode.includes("E48")?"2%":"1%");
      }

      document.getElementById("answer").innerText = "";
    }

    function showAnswer() {
      document.getElementById("answer").innerText = currentAnswer;
    }

    newQuestion();
  </script>
</body>
</html>
